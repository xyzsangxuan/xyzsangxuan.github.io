---
title: Unity3d网络游戏架构-主程
date: 2020-07-03 16:30:44

tags: 
    - 软件工程
categories: 
    - 游戏引擎
    - Unity
cover: /img/cover11.png
top_img: /img/cover11.png
mathjax: false
description: 从零开始搭建一个Unity3d商业化的网络游戏框架
---
## 前言
&ensp;&ensp;&ensp;&ensp; 扩展:ECS 面向数据的特性可以提供大量实体,应用ECS尝试着融合成一个完整的游戏开发框架。

&ensp;&ensp;&ensp;&ensp; 扩展:ET 框架可以简化客户端和服务端的开发，快速上线。
## 游戏基础模块

| 游戏基础模块 |  |  |  |  |
| ---- | ---- | ---- | ---- | ---- |
| UI体系  | 简单的UI体系 | Login界面  | ||
|  |  | 选角色界面  |||
|  |  | 创建角色界面  |||
|  | 核心UI体系 | 战斗界面 | UI分层  ||
|  |  |  | 摇杆  ||
|  |  |  | 技能 ||
|  |  |  | 点击场景交互 ||
|  |  |  | 功能大厅 ||
|  |  |  | 小地图 ||
|  | 系统界面 | 属性,背包,宠物,合成,强化等系统 |||
|  | 常用UI效果 | UI模型 |||
| 场景控制 | 创建角色 ||||
|  | 行走 ||||
|  | 摄像机跟随 ||||
|  | 点击场景 ||||
|  | 场景与UI解耦 ||||
|  | 技能状态 ||||
| 通用模块 | 配置表 ||||
|  | 网络交互||||
|  | 工具模块 ||||
|  | 通用模块 ||||
|  | 游戏逻辑模块 ||||
|  | Editor简单编写 ||||
| 其他 | 热更新  ||||
|  | 渲染  ||||
|  | 性能优化  ||||

## 敏捷式开发
&ensp;&ensp;&ensp;&ensp;游戏行业往往采用敏捷开发，用测试驱动开发（TDD）

&ensp;&ensp;&ensp;&ensp;从零开始 ：启动->闪屏(（Logo、防沉迷）)->检查更新->更新(重启)->公告->->登录...

## 版本控制工具
&ensp;&ensp;&ensp;&ensp;Git

## 环境搭建
* Unity package安装

&ensp;&ensp;&ensp;&ensp;Burst:p.11 1.2.0

&ensp;&ensp;&ensp;&ensp;Entities:p.4 0.3.0

&ensp;&ensp;&ensp;&ensp;Hybrid Renderer: p.4 0.3.0

&ensp;&ensp;&ensp;&ensp;Unity Physics:p 0.2.4

&ensp;&ensp;&ensp;&ensp;Universal RP:7.3.1

## 搭建基本环境

* 泛型单例模式
* 扩展类的成员函数
* 游戏启动流程


## 游戏表格配置（角色表，Npc表，，地图表，技能表等）
* 让策划和美术直接方便修改游戏，避免产生逻辑错误，减少程序员的工作量。

&ensp;&ensp;&ensp;&ensp;目标：能读表就读表
* 常用配置文件格式

| 常用配置文件格式 |  |  
| ---- | ---- |  
| Excel  | 最常用的表格工具，大家都会用 |
| Csv |  轻量级表格数据格式。字段以“，”分隔；数据条目以“回车”分隔  |
| XML |  在表示树形结构方面非常方便（慢）  |
| Json | 最好用的格式，与程序员可以一键转换（编辑起来不方便） |
* 字符集和文件编码
  * 字符集：ASCII、Unicode...
  * 文件编码：ANSI、UTF-8...

* 读取二进制文件
  * Resources.Load<TextAsset>("Filepath");
  * FilePath的扩展名需要时".bytes"
  * 我们自己来解析二进制文件：
  ```
  var reader = new StreamReader(tableStream,Encoding.GetEncoding("gb2312))
  ```
* 反射
  * 反射的作用：运行期获取字段、类型、方法
  * 通俗点：使用字符串，映射出类、字段、方法。
  * 再直白点：OneClass.MyName;OneClas["MyName"].一个类的名字的字符串，也可以映射到具体的类定义
  * 反射字段
    * 使用FieldInfo,表示类中的字段信息
    * Type.GetField(columName),获取字段信息。
    * 使用FieldInfo.FieldType获取该字段的类型。
    * 使用FieldInfo.SetValue给对象的字段赋值

## UnityEditor简单编程快速切换场景、一键打包数据

## 模拟与服务器交互（登录，创建角色，进入到游戏...

* 一种简单的服务器架构


* 1、定义Net类来负责所有的网络相关事宜。
* 2、客户端要发消息，顶一个发消息的方法 SendCmd。
* 3、客户端需要接收消息，定义一个收消息的方法Receive。
* 4、需要与服务器建立连接，抽象一个服务器接口。
* 5、发送一个消息（Login）。

## 角色管理RoleManager

## 使用数据库存储游戏数据
sqlite / Mysql？

本来我是想使用Mysql的，因为之前用过Mysql，体验也蛮好的。

但是SQLite目前应该是更好的选择，因为轻量、稳定和易用。如果后期需要换数据库再考虑
* Unity &Sqlite

* 在Unity使用Sqlite、

&ensp;&ensp;&ensp;&ensp;使用Unity操作SQLite，需要用到三个库文件，分别是Mono.Data.Sqlite.dll和System.Data.dll和Sqlite3.dll，前两个库文件可以在unity中找到，Sqlite3.dll可以去官网下载或者本地搜索
```
//我用的是这个路径
2019.4.1f1\Editor\Data\MonoBleedingEdge\lib\mono\4.5
```
* 在Unity中使用LitJson解析json文件:  
这个库需要找资源，找到LitJson.dll后将它放在Assets文件夹下，在脚本中使用using引入即可


## 脱离MonoBehaviour自己驱动游戏逻辑

## NavMesh寻路；指定目标行走

## 计时器Timer

## UIManager

## 摄像机跟随

## 战斗场景UI管理

## 摇杆控制实现

## 点击场景控制实现
---------------------------------------------------------

## 通过Npc跳转场景

## Dialog管理

## 功能大厅，角色属性界面实现（抽象UIModel）

## 选中Npc实现
* Npc头像框
* 下拉列表
* 访问Npc，自动走打到Npc附近再触发访问

## AI状态机
* 感知（周围生物，区分敌友）
* 决策（大脑，根据感知系统的信息，决定具体要做什么）
* 行动（四肢 
* 如果自己实现的可以满足要求，则使用自己创建的，但是合理利用一款不错的插件可以大幅提升开发效率


## 技能UI面板
* 技能千奇百怪，需求不明，涉及多个模块、耦合性高，对象间交互，模块间交互，数据间交互，可以和任何模块交互
* 技能分类：单体（单的AOE）、AOE；近战（近的远）、远程；瞬发、吟唱；一次瞬间结算、持续伤害、多次瞬间伤害（多次一次）；敌方、己方、无差别；点选、范围。
* 正交设计模式进行正交程序设计、模块耦合度最低；面向对象；重构；需求分析；抽象；接口设计
## 放一个火球

## FlyObject

## 最原始的SkillSampleFireBall

## 技能基础框架2（TimeLine）

## 技能配置表

## 技能基础框架（SkillMgr，SkillCaster）

* 时间线
* 技能不同时释放
* 放技能时不移动，不响应其他活动

## 瞬间伤害技能

## AOE技能

## SkillLogic动态实例化（反射）

---------------------------------------------------------
## 施法范围限定

## 技能伤害

## 伤害数值配置


## 属性变化监听

## 与服务器对接实战
异步通信搭建服务器

C#子线程执行完后，利用委托调用主线程的方法

## Npc分类，功能Npc和怪物Npc

## 自动选择目标

## 持续性伤害结算
持续n秒，走进区域的敌人，收到伤害；
对半径为R的区域每秒造成伤害，持续n秒

## 辅助追踪目标



## Npc攻击主角


## 角色状态控制



## 死亡与重生


## 技能CD
---------------------------------------------------------
PS.
## 推波技能

## 定制技能（扩展时间线）

## 通用提示框

## 小地图

## 道具拾取

## 背包系统

## 任务系统


## 装备


## 坐骑

